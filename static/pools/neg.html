<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>dynamic to static to img</title>

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">
<style>
#map-container, #static-map-container {
  width: 400px;
  height: 400px;
}
</style>
</head><body>

<div class="row">

  <div class="col-md-4">
    <div id="map-container">
    </div>
  </div>

  <div class="col-md-2">      
      <ol>Capture new negative (bg) image.
        <li>Create a working copy by clicking <button class="pure-button pure-button-primary" id="btnDraw"> =&gt; </button></li>
        <li>Save as data by clicking <button class="pure-button pure-button-primary" id="btnSave"> Save </button></li>
      </ol>
  </div>

  <div class="col-md-4" id="staticmap-container">
    <canvas id="staticmap-canvas"></canvas>
  </div>

</div>

<script>
var map;// dynamic v3 not static

var a_from_path = function (path) {
  return "<a href='"+path+"'>"+path+"</a>";
};

function initMap() {

  var mapOptions = {
    zoom: 18,
    center: new google.maps.LatLng(43.35975, -79.77),
    mapTypeId: google.maps.MapTypeId.SATELLITE,
    disableDefaultUI: true,
    zoomControl: true,
    streetViewControl: false
  };
  map = new google.maps.Map(document.getElementById('map-container'), mapOptions);

  wireUpHandlers();

  return "done";
}

function inspect() {
  const ne = map.getBounds().getNorthEast();
  const sw = map.getBounds().getSouthWest();
  console.log('ne', ne);
  console.log('sw', sw);
  console.log('w', sw.lng()-ne.lng());
  console.log('h', sw.lat()-ne.lat());
}


var wireUpHandlers = function () {

  var imageObj = new Image();

  // google maps come in 2 flavors, interactive and static
  // static is the one we want to send back to the server to be used in Trainig
  // so we want to mirror interactive in static image
  google.maps.event.addDomListener(document.getElementById("btnDraw"), 'click', function () {

    var drawImage = function (img, canvas) {
      canvas.width = img.width;
      canvas.height = img.height;
      canvas.getContext("2d").drawImage(img, 0, 0, img.width, img.height);

      return canvas;
    };

    imageObj.onload = function() {
      var canvasUnder = document.getElementById("staticmap-canvas");
      drawImage(this, canvasUnder);
    };

    let url = `https://maps.googleapis.com/maps/api/staticmap?center=${ map.getCenter().lat() },${ map.getCenter().lng()}&zoom=${ map.getZoom() }&size=400x400&maptype=satellite&key=AIzaSyDJHNZPgCpEYbDmr_dn6Y66U0jXxzeeErQ&`;
    imageObj.onload = function() {
      var canvasUnder = document.getElementById("staticmap-canvas");
      drawImage(this, canvasUnder);
    };
    imageObj.src = url;

    //imageObj.src = "/staticmap?"+qry(latLng.lat(), latLng.lng(), 400, 400, zoom);

    return "done";
  });

  google.maps.event.addDomListener(document.getElementById("btnSave"), 'click', function () {

    // send over clean image
    var canvas = document.createElement("canvas");
    canvas.getContext("2d").drawImage(imageObj, 0, 0, imageObj.width, imageObj.height);

    var imgData = canvas.toDataURL();
    console.log("payload 2 map images", imgData);

    var request = $.ajax({
      url: "/negative",
      method: "POST",
      data: { imgData : imgData },
      dataType: "text"
    });
    request.done(function( msg ) {
      alert( msg );

      var hrefs = ["<br/>", a_from_path(msg)];
      console.log(hrefs);
      $( "#img-links" ).append(hrefs);

    });
    request.fail(function( jqXHR, textStatus ) {
      alert( "Request failed: " + textStatus );
    });
  });
};

</script>
    
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDJHNZPgCpEYbDmr_dn6Y66U0jXxzeeErQ&v=3&libraries=geometry&callback=initMap"></script> 
</body></html>